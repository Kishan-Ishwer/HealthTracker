version: '3.8'

services:
  # 1. Database Service
  tracker-db:
    image: postgres:latest
    container_name: tracker-db
    restart: always
    environment:
      POSTGRES_USER: healthtracker
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Assumes this is set in .env
      POSTGRES_DB: healthtracker_db
    ports:
      - "5432:5432"
    volumes:
      - healthtracker_postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Messaging Service
  rabbitmq-server:
    image: rabbitmq:3-management-alpine # Use a version with the management plugin for ease
    container_name: rabbitmq-server
    hostname: rabbitmq-server
    ports:
      - "5672:5672" # Standard AMQP port
      - "15672:15672" # Management UI port
    environment:
      # These must match the variables used by your Node and Analytics services
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER} 
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS}
    # Using a volume is optional but recommended for persistence
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq/mnesia
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 5s
      timeout: 15s
      retries: 5
      start_period: 20s

  # 3. Node.js Server
  server-node:
    build:
      context: ./server-node
      dockerfile: Dockerfile.node
    container_name: server-node
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: postgres://healthtracker:${POSTGRES_PASSWORD}@tracker-db:5432/healthtracker_db
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq-server:5672
    depends_on:
      tracker-db:
        condition: service_healthy
      rabbitmq-server:
        condition: service_healthy

  analyticsservice:
    build:
      context: ./server-dotnet/AnalyticsService
      dockerfile: Dockerfile
    container_name: analyticsservice
    restart: always
    environment:
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASS}@rabbitmq-server:5672
    depends_on:
      rabbitmq-server:
        condition: service_healthy

volumes:
  healthtracker_postgres_data:
    name: healthtracker_postgres_data
  rabbitmq_data: